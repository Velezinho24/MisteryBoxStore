{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Register" %} · MysteryVault{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card bg-dark border-danger-subtle shadow rounded-3">
        <div class="card-header text-white text-center bg-danger">
          <h3 class="h5 mb-0">{% trans "Create an Account" %}</h3>
        </div>

        <div class="card-body p-4">
          <form method="post" novalidate id="register-form">
            {% csrf_token %}

            {% if form.non_field_errors %}
              <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}

            <!-- username -->
            <div class="mb-3">
              <label class="form-label" for="{{ form.username.id_for_label }}">{{ form.username.label }}</label>
              {{ form.username }}
              {% if form.username.help_text %}
                <div class="form-text text-secondary small">{{ form.username.help_text|safe }}</div>
              {% endif %}
              {% if form.username.errors %}
                <div class="text-danger small">{{ form.username.errors|striptags }}</div>
              {% endif %}
            </div>

            <!-- email -->
            <div class="mb-3">
              <label class="form-label" for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
              {{ form.email }}
              {% if form.email.help_text %}
                <div class="form-text text-secondary small">{{ form.email.help_text|safe }}</div>
              {% endif %}
              {% if form.email.errors %}
                <div class="text-danger small">{{ form.email.errors|striptags }}</div>
              {% endif %}
            </div>

            <!-- password1 + checklist -->
            <div class="mb-3">
              <label class="form-label" for="{{ form.password1.id_for_label }}">{{ form.password1.label }}</label>
              {{ form.password1 }}
              <div id="pw-rules" class="small mt-2">
                <div class="text-secondary" data-rule="length">{% trans "At least 8 characters" %}</div>
                <div class="text-secondary" data-rule="upper">{% trans "Contains an uppercase letter" %}</div>
                <div class="text-secondary" data-rule="lower">{% trans "Contains a lowercase letter" %}</div>
                <div class="text-secondary" data-rule="digit">{% trans "Contains a number" %}</div>
                <div class="text-secondary" data-rule="special">{% trans "Contains a special character (!@#$%^&* etc.)" %}</div>
              </div>
              {% if form.password1.errors %}
                <div class="text-danger small mt-1">{{ form.password1.errors|striptags }}</div>
              {% endif %}
            </div>

            <!-- password2 + match -->
            <div class="mb-3">
              <label class="form-label" for="{{ form.password2.id_for_label }}">{{ form.password2.label }}</label>
              {{ form.password2 }}
              <div id="pw-match" class="small mt-2 text-secondary" data-rule="match">
                {% trans "Passwords match" %}
              </div>
              {% if form.password2.errors %}
                <div class="text-danger small mt-1">{{ form.password2.errors|striptags }}</div>
              {% endif %}
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-danger">
                {% trans "Create account" %}
              </button>
            </div>
          </form>
        </div>

        <div class="card-footer text-center bg-black">
          <small class="text-secondary">
            {% trans "Already have an account?" %}
            <a href="{% url 'accounts:login' %}" class="link-danger">{% trans "Login here" %}</a>
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
(function(){
  const pw1 = document.getElementById("id_password1");
  const pw2 = document.getElementById("id_password2");
  const rules = {
    length:  (s)=> s.length >= 8,
    upper:   (s)=> /[A-Z]/.test(s),
    lower:   (s)=> /[a-z]/.test(s),
    digit:   (s)=> /[0-9]/.test(s),
    special: (s)=> /[^A-Za-z0-9]/.test(s),
    match:   ()=> pw1.value.length>0 && pw1.value === pw2.value
  };

  function updateRules(){
    const val1 = pw1.value || "";
    const val2 = pw2.value || "";
    // Reglas de password1
    document.querySelectorAll("#pw-rules [data-rule]").forEach(function(el){
      const key = el.getAttribute("data-rule");
      const ok = rules[key] ? rules[key](val1) : true;
      if(ok){
        // “Se va borrando” al cumplirse
        el.remove();
      }
    });
    // Match rule (no la borramos, solo cambiamos estado)
    const matchEl = document.getElementById("pw-match");
    if (matchEl){
      const okMatch = rules.match();
      matchEl.classList.toggle("text-success", okMatch);
      matchEl.classList.toggle("text-secondary", !okMatch);
    }
  }

  if(pw1){ pw1.addEventListener("input", updateRules); }
  if(pw2){ pw2.addEventListener("input", updateRules); }
})();
</script>
{% endblock %}
{% endblock %}